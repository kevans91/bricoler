-- Copyright (c) Mark Johnston <markj@FreeBSD.org>

Params = {
    tests = {
        descr = "Tests to run, relative to /usr/tests",
    }
}

Inputs = {
    VM = {
        task = "freebsd/vm-boot",
        params = {
            image = {
                -- XXX-MJ need to plumb a bunch of stuff into VM image creation.
                -- - sysctls (e.g. kern.ipc.tls.enabled)
                -- - kernel modules
                -- XXX-MJ need to provide some extra disks for the ZFS tests
                image_size = "50g",
                pkgs = "python py39-pytest py39-scapy perl5 jq ksh93 openvpn llvm gtar",
                ssh_users = "root",
                build = {
                    make_args = "WITHOUT_CLANG= WITHOUT_LLD= WITHOUT_LLDB= WITHOUT_LIB32= WITH_DTRACE_TESTS="
                }
            },
        },
    }
}

Outputs = {
    resultsdb = {
        descr = "Results database from kyua",
    },
}

function Run(_, params, inputs)
    -- XXX-MJ hard-coded parallelism
    -- XXX-MJ should be an attribute of the VM
    local kyua = "kyua -v parallelism=4 test -k /usr/tests/Kyuafile"
    if params.tests then
        kyua = kyua .. " " .. params.tests
    end

    local VM = inputs.VM.handle
    VM:boot()
    VM:expect("send -- \"sysctl kern.ipc.tls.enable=1\\n\"")
    VM:expect("send -- \"sysctl vfs.aio.enable_unsafe=1\\n\"")
    VM:expect("send -- \"kldload ipsec pf pfsync if_ovpn\\n\"")
    VM:expect("send -- \"" .. kyua .. "\\n\"")
    VM:expect("expect eof")

    -- XXX-MJ download resultsdb and show the report
end

-- vi:ft=lua
