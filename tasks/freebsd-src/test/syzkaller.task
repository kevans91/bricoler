-- Copyright (c) 2022 Mark Johnston <markj@FreeBSD.org>

Params = {
    dataset = {
        descr = "ZFS dataset to use for VM image cloning",
        required = true,
    },
    numvms = {
        descr = "Number of VMs to run",
    },
}

Inputs = {
    vm_image = {
        task = "freebsd-src/build/vm-image",
    },
    syzkaller = {
        task = "syzkaller/build"
    },
}

function Run()
    mkdir("./workdir")
    writefile("./syz-manager.conf", [[
{
    "target": "freebsd/amd64",
    "http": 0.0.0.0:8081,
    "workdir": "./workdir",
    "image": <path to VM image file>
    "syzkaller": <path to syzkaller checkout>
    "procs": 2,
    "type": "bhyve",
    "ssh_user": "root",
    "sshkey": <path to SSH key>
    "kernel_obj: <path to build object directory>
    "kernel_src": "/",
    "vm": {
        "bridge": <bridge interface>,
        "count": 1,
        "cpu": 2,
        "mem": "2G",
        "hostip": <bridge address>,
        "dataset": <ZFS dataset name>,
    }
}
]])
end

-- vi: ft=lua
